<UserControl x:Class="BudgetAnalyser.Statement.StatementUserControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             mc:Ignorable="d"
             xmlns:converters="clr-namespace:BudgetAnalyser.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             DataContextChanged="OnDataContextChanged">

    <UserControl.Resources>
        <converters:NumberSignToColorConverter x:Key="NumberSignToColorConverter" />
    </UserControl.Resources>

    <UserControl.InputBindings>
        <KeyBinding Key="O"
                    Command="{Binding OpenStatementCommand}"
                    Modifiers="Control" />
        <KeyBinding Key="S"
                    Command="{Binding SaveStatementCommand}"
                    Modifiers="Control" />
        <KeyBinding Key="X"
                    Command="{Binding CloseStatementCommand}"
                    Modifiers="Control" />
    </UserControl.InputBindings>

    <Grid Background="{StaticResource MainBackgroundBrush}">
        <Grid.RowDefinitions>
            <!-- Menu bar -->
            <RowDefinition Height="Auto" />
            <!-- Tool bar -->
            <RowDefinition Height="Auto" />
            <!-- Transaction Headers -->
            <RowDefinition Height="*" />
            <!-- Transaction List -->
        </Grid.RowDefinitions>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <StackPanel Margin="8,2,2,2"
                        Orientation="Horizontal">
                <TextBlock Style="{StaticResource TextBlockHeading1}"
                           Text="{Binding ViewModel.StatementName}" />
                <TextBlock Style="{StaticResource TextBlockHeading1}" 
                           Text="*"
                           Visibility="{Binding ViewModel.Dirty, Converter={StaticResource BoolToVisConverter}}"/>
            </StackPanel>
            <StackPanel Grid.Column="1"
                        HorizontalAlignment="Right"
                        IsEnabled="{Binding BackgroundJob.MenuAvailable}"
                        Orientation="Horizontal">
                <Menu IsEnabled="{Binding BackgroundJob.MenuAvailable}"
                      Style="{StaticResource MenuStyle1}"
                      Foreground="{StaticResource ButtonGlyphBrush}"
                      Background="{StaticResource ButtonBackgroundBrush}"
                      BorderBrush="{StaticResource ButtonStrokeBrush}"
                      BorderThickness="3">
                    <Menu.Resources>
                        <Style TargetType="{x:Type TextBlock}">
                            <Setter Property="Foreground"
                                    Value="{StaticResource ButtonGlyphBrush}" />
                        </Style>
                    </Menu.Resources>
                    <MenuItem Style="{StaticResource MenuItemStyle1}">
                        <MenuItem.Header>
                            <TextBlock Text="Recent..."
                                       FontSize="14"
                                       Foreground="{StaticResource ButtonGlyphBrush}" />
                        </MenuItem.Header>
                        <MenuItem Command="{Binding RecentFile1Command}"
                                  CommandParameter="{Binding RecentFile1Command.FullFileName}"
                                  ToolTip="{Binding RecentFile1Command.FullFileName}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Margin="-15,0,2,0"
                                               Text="1" />
                                    <TextBlock Text="{Binding RecentFile1Command.Name}" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding RecentFile2Command}"
                                  CommandParameter="{Binding RecentFile2Command.FullFileName}"
                                  ToolTip="{Binding RecentFile2Command.FullFileName}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Margin="-15,0,2,0"
                                               Text="2" />
                                    <TextBlock Text="{Binding RecentFile2Command.Name}" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding RecentFile3Command}"
                                  CommandParameter="{Binding RecentFile3Command.FullFileName}"
                                  ToolTip="{Binding RecentFile3Command.FullFileName}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Margin="-15,0,2,0"
                                               Text="3" />
                                    <TextBlock Text="{Binding RecentFile3Command.Name}" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding RecentFile4Command}"
                                  CommandParameter="{Binding RecentFile4Command.FullFileName}"
                                  ToolTip="{Binding RecentFile4Command.FullFileName}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Margin="-15,0,2,0"
                                               Text="4" />
                                    <TextBlock Text="{Binding RecentFile4Command.Name}" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding RecentFile5Command}"
                                  CommandParameter="{Binding RecentFile5Command.FullFileName}"
                                  ToolTip="{Binding RecentFile5Command.FullFileName}">
                            <MenuItem.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Margin="-15,0,2,0"
                                               Text="5" />
                                    <TextBlock Text="{Binding RecentFile5Command.Name}" />
                                </StackPanel>
                            </MenuItem.Header>
                        </MenuItem>
                    </MenuItem>
                </Menu>
                <Button Command="{Binding OpenStatementCommand}"
                        Style="{StaticResource NewButton}"
                        ToolTip="Load Transactions (Ctrl+O)" />
                <Button Command="{Binding CloseStatementCommand}"
                        Style="{StaticResource ClearButton}"
                        ToolTip="Close Transactions (Ctrl+X)" />
                <Button Command="{Binding SaveStatementCommand}"
                        Style="{StaticResource SaveButton}"
                        ToolTip="Save Transactions (Ctrl+S)" />
                <Button Command="{Binding MergeStatementCommand}"
                        Style="{StaticResource LoadButton}"
                        ToolTip="Merge in new Transactions" />
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1">
            <!-- Tool bar -->
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <StackPanel Orientation="Horizontal"
                        SnapsToDevicePixels="True"
                        TextBlock.Foreground="{StaticResource MainBackgroundBrush}">
                <TextBlock Background="{StaticResource NeutralNumberBackgroundBrush}"
                           Margin="4"
                           Padding="4"
                           Text="Loading Data..."
                           Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource NotBoolToVisConverter}}" />
                <Border Background="{StaticResource CreditBackground1Brush}"
                        Style="{StaticResource WarningOilLightStyle}"
                        Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="CR: " />
                        <TextBlock FontSize="16"
                                   Style="{StaticResource WarningLightTextStyle}"
                                   Text="{Binding ViewModel.TotalCredits, StringFormat=C}" />
                    </StackPanel>
                </Border>
                <Border Background="{StaticResource DebitBackground1Brush}"
                        Style="{StaticResource WarningOilLightStyle}"
                        Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="DR: " />
                        <TextBlock FontSize="16"
                                   Style="{StaticResource WarningLightTextStyle}"
                                   Text="{Binding ViewModel.TotalDebits, StringFormat=C}" />
                    </StackPanel>
                </Border>
                <Border
                    Background="{Binding ViewModel.TotalDifference, Converter={StaticResource NumberSignToColorConverter}}"
                    Style="{StaticResource WarningOilLightStyle}"
                    Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="Difference: " />
                        <TextBlock FontSize="16"
                                   Style="{StaticResource WarningLightTextStyle}"
                                   Text="{Binding ViewModel.TotalDifference, StringFormat=C}" />
                    </StackPanel>
                </Border>
                <Border Background="{StaticResource DebitBackground1Brush}"
                        Style="{StaticResource WarningOilLightStyle}"
                        Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="Average DR: " />
                        <TextBlock FontSize="16"
                                   Style="{StaticResource WarningLightTextStyle}"
                                   Text="{Binding ViewModel.AverageDebit, StringFormat=C}" />
                    </StackPanel>
                </Border>
                <Border Background="{StaticResource NeutralNumberBackgroundBrush}"
                        Style="{StaticResource WarningOilLightStyle}"
                        Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="Count: " />
                        <TextBlock FontSize="16"
                                   Style="{StaticResource WarningLightTextStyle}"
                                   Text="{Binding ViewModel.TotalCount}" />
                    </StackPanel>
                </Border>
                <Border Background="{StaticResource NeutralNumberBackgroundBrush}"
                        Style="{StaticResource WarningOilLightStyle}"
                        Visibility="{Binding BackgroundJob.MenuAvailable, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="Months: " />
                        <TextBlock FontSize="16"
                                   Style="{StaticResource WarningLightTextStyle}"
                                   Text="{Binding ViewModel.Statement.DurationInMonths}" />
                    </StackPanel>
                </Border>
                <Border Background="{StaticResource ImportantHighlightLightBrush}"
                        Style="{StaticResource WarningOilLightStyle}"
                        Visibility="{Binding ViewModel.DuplicateSummary, Converter={StaticResource NullToVisConverter}}">
                    <TextBlock Style="{StaticResource WarningLightTextStyle}"
                               Text="{Binding ViewModel.DuplicateSummary}"
                               ToolTip="Potentially corrupt data exists in the statement. Some transactions appear as exact duplicates of others. Look for pink highlighted rows." />
                </Border>
            </StackPanel>
            <StackPanel Grid.Column="1"
                        Orientation="Horizontal">
                <TextBlock HorizontalAlignment="Right"
                           Margin="4"
                           Text="Budget Bucket Filter" />
                <ComboBox IsEnabled="{Binding BackgroundJob.MenuAvailable}"
                          ItemContainerStyle="{StaticResource BudgetBucketComboItemStyle}"
                          ItemsSource="{Binding ViewModel.FilterBudgetBuckets}"
                          Margin="4"
                          SelectedItem="{Binding ViewModel.BucketFilter}"
                          Width="100" />
            </StackPanel>
        </Grid>
        <Grid Grid.Row="2"
              IsSharedSizeScope="True">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <!--<ScrollViewer x:Name="HeaderScrollViewer"
                          Background="{StaticResource MainBackgroundBrush}"
                          HorizontalScrollBarVisibility="Hidden"
                          VerticalScrollBarVisibility="Hidden">
                <Grid Height="50"
                      Margin="17,0,10,0">
                    <Grid.Resources>

                        <Style BasedOn="{StaticResource TransactionTextBlockStyle}"
                               TargetType="TextBlock">
                            <Setter Property="FontSize"
                                    Value="16" />
                            <Setter Property="VerticalAlignment"
                                    Value="Center" />
                        </Style>
                    </Grid.Resources>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition SharedSizeGroup="A"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="B"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="C"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="D"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="E"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="F"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="G"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="H"
                                          Width="Auto" />
                        <ColumnDefinition SharedSizeGroup="I"
                                          Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Date" />
                    <TextBlock Grid.Column="1"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Amount" />
                    <TextBlock Grid.Column="2"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Description" />
                    <TextBlock Grid.Column="3"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Budget" />
                    <TextBlock Grid.Column="4"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Reference 1" />
                    <TextBlock Grid.Column="5"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Reference 2" />
                    <TextBlock Grid.Column="6"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Reference 3" />
                    <TextBlock Grid.Column="7"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Transaction Type" />
                    <TextBlock Grid.Column="8"
                               HorizontalAlignment="Center"
                               Margin="0"
                               Text="Account" />
                </Grid>
            </ScrollViewer>-->
            <!-- 
            The Control Template for the transaction list box must be inline here so an event can be attached to internal list box Scroll Viewer. 
            This is so the horizontal scroll can be sync'ed with the header grid horizontal scroll.
            -->
            <StackPanel Grid.Row="1"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                <StackPanel Visibility="{Binding ViewModel.Statement, Converter={StaticResource NullToVisConverter}}">
                    <Border HorizontalAlignment="Center"
                            Style="{StaticResource WarningOilLightStyle}"
                            VerticalAlignment="Center"
                            Visibility="{Binding ViewModel.HasTransactions, Converter={StaticResource NotBoolToVisConverter}}">
                        <TextBlock Style="{StaticResource WarningLightTextStyle}"
                                   Text="No Transactions, with current filter."
                                   ToolTip="Check the current global filter to widen the search, or clear the filter completely and show all transactions in the loaded statement file." />
                    </Border>
                </StackPanel>

                <Border HorizontalAlignment="Center"
                        Style="{StaticResource RedWarningOilLightStyle}"
                        VerticalAlignment="Center"
                        Visibility="{Binding ViewModel.Statement, Converter={StaticResource NotNullToVisConverter}}">
                    <TextBlock Style="{StaticResource WarningLightTextStyle}"
                               Text="No transactions file loaded."
                               ToolTip="Load a transactions csv file." />
                </Border>

                <StackPanel Orientation="Horizontal"
                            Visibility="{Binding ViewModel.Statement, Converter={StaticResource NotNullToVisConverter}}">
                    <Button Command="{Binding DemoStatementCommand}"
                            Margin="20,20,4,20"
                            Style="{StaticResource HappyButton}"
                            ToolTip="Load a demo set of transactions" />
                    <TextBlock Text="Load a demonstration set of transactions." />
                </StackPanel>
            </StackPanel>

            <ListBox x:Name="TransactionListBox"
                     AlternationCount="2"
                     Grid.Row="1"
                     IsTextSearchEnabled="False"
                     ItemsSource="{Binding ViewModel.Statement.Transactions}"
                     KeyUp="OnTransactionListBoxKeyUp"
                     SelectedItem="{Binding SelectedRow}"
                     SelectionChanged="OnTransactionSelectionChanged"
                     SelectionMode="Single"
                     Visibility="{Binding ViewModel.HasTransactions, Converter={StaticResource BoolToVisConverter}}">
                <!--MouseDoubleClick="OnTransactionListBoxDoubleClick"-->
                <ListBox.Style>

                    <Style TargetType="ListBox">
                        <Setter Property="ItemContainerStyle"
                                Value="{StaticResource TransactionListBoxContainer}" />
                        <Setter Property="HorizontalAlignment"
                                Value="Stretch" />
                        <Setter Property="SnapsToDevicePixels"
                                Value="true" />
                        <Setter Property="OverridesDefaultStyle"
                                Value="true" />
                        <Setter Property="ScrollViewer.HorizontalScrollBarVisibility"
                                Value="Auto" />
                        <Setter Property="ScrollViewer.VerticalScrollBarVisibility"
                                Value="Auto" />
                        <Setter Property="ScrollViewer.CanContentScroll"
                                Value="true" />
                        <Setter Property="MinWidth"
                                Value="120" />
                        <Setter Property="MinHeight"
                                Value="95" />
                        <Setter Property="Template">
                            <Setter.Value>

                                <ControlTemplate TargetType="ListBox">
                                    <Border x:Name="Border"
                                            BorderThickness="1"
                                            CornerRadius="2">
                                        <Border.Background>
                                            <SolidColorBrush Color="Transparent" />
                                        </Border.Background>
                                        <Border.BorderBrush>
                                            <SolidColorBrush Color="Transparent" />
                                        </Border.BorderBrush>
                                        <ScrollViewer Focusable="false"
                                                      Margin="0">
                                            <StackPanel IsItemsHost="True"
                                                        Margin="2" />
                                        </ScrollViewer>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsEnabled"
                                                 Value="false">
                                            <Setter Property="Background"
                                                    TargetName="Border">
                                                <Setter.Value>
                                                    <SolidColorBrush Color="Silver" />
                                                </Setter.Value>
                                            </Setter>
                                            <Setter Property="BorderBrush"
                                                    TargetName="Border">
                                                <Setter.Value>
                                                    <SolidColorBrush Color="LightGray" />
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                        <Trigger Property="IsGrouping"
                                                 Value="true">
                                            <Setter Property="ScrollViewer.CanContentScroll"
                                                    Value="false" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.Style>
                <ListBox.ContextMenu>
                    <ContextMenu HasDropShadow="true">
                        <ContextMenu.Resources>

                            <Style TargetType="{x:Type TextBlock}">
                                <Setter Property="Foreground"
                                        Value="Black" />
                            </Style>
                        </ContextMenu.Resources>
                        <MenuItem Command="{Binding AppliedRulesController.ApplyRulesCommand}">
                            <MenuItem.Header>
                                <TextBlock Text="Apply Matching Rules" />
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding AppliedRulesController.CreateRuleCommand}">
                            <MenuItem.Header>
                                <TextBlock Text="Create Rule" />
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding AppliedRulesController.ShowRulesCommand}">
                            <MenuItem.Header>
                                <TextBlock Text="Edit Rules" />
                            </MenuItem.Header>
                        </MenuItem>
                        <Separator />
                        <MenuItem Click="OnEditTransaction">
                            <MenuItem.Header>
                                <TextBlock Text="Edit Transaction" />
                            </MenuItem.Header>
                        </MenuItem>
                        <MenuItem Command="{Binding DeleteTransactionCommand}">
                            <MenuItem.Header>
                                <TextBlock Text="Delete Transaction" />
                            </MenuItem.Header>
                        </MenuItem>
                    </ContextMenu>
                </ListBox.ContextMenu>
            </ListBox>
        </Grid>
    </Grid>

</UserControl>